<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/" type="image/x-icon" />
    <title>You Know Me Better?</title>
    <script>
      const questions = JSON.parse(`{{}}`);
    </script>
  </head>
  <body>
    <div id="header">
      <div id="title">You Know Me Better?</div>
    </div>
    <div id="body">
      <div id="page1">
        <div id="intro">
          &quot;You Know Me Better?&quot; is a fun project that allows you to
          send quizzes about yourself to your friends, relatives or anyone else
          and let yourself know, who knows you better
        </div>
        <form>
          <label for="name">Enter your name to get started</label>
          <fieldset>
            <legend>Name</legend>
            <input
              type="text"
              pattern="[a-zA-Z0-9_ ]+"
              name="uname"
              oninvalid="this.setCustomValidity('only letters, numbers, spaces and underscores are allowed')"
              oninput="this.setCustomValidity('')"
              onkeydown="this.setCustomValidity('')"
              required
            />
          </fieldset>
          <button type="submit">go</button>
        </form>
      </div>

      <div id="page2" hidden>
        <div id="sub-heading">Create your own quiz</div>
        <form>
          <label for="number">Number of questions:</label>
          <select id="number">
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option selected>10</option>
            <option>11</option>
            <option>12</option>
            <option>13</option>
            <option>14</option>
            <option>15</option>
          </select>
        </form>
        <div id="quesarea">
          <button id="skip">skip this question</button>
          <div id="queshash">Q1</div>
          <div id="ques"></div>
          <div id="ops"></div>
        </div>
      </div>

      <div id="page3"></div>
    </div>

    <script>
      let f = document.getElementById("number");
      let ques = document.getElementById("ques");
      let ops = document.getElementById("ops");
      let qh = document.getElementById("queshash");
      let skip = document.getElementById("skip");
      let qhash = 0;
      let currques;
      let lc;
      let qc = 10;
      let p1 = document.getElementById("page1");
      let p2 = document.getElementById("page2");
      let p3 = document.getElementById("page3");
      let form = document.forms[0];

      const self = {
        ques: []
      };

      let repques = [];
      function pickques() {
        let ind =
          Math.floor((Math.random() * 100) % Object.keys(questions).length) + 1;
        if (repques.includes(ind)) return;
        else {
          repques.push(ind);
          return questions[ind];
        }
      }
      function dispques() {
        currques = pickques();
        if (currques) {
          ques.innerText = currques.q;
          let op = [];
          currques.op.forEach(o => {
            lc = o;
            if (o[1]) {
              op.push(
                '<span><img width="100" height="100" src="' +
                  location.protocol +
                  "//" +
                  location.hostname +
                  "/images" +
                  o[1] +
                  '"><br><button onclick="btcl(this, currques, currques.op.indexOf(lc))">' +
                  o[0] +
                  "</button></span><br>"
              );
            } else {
              op.push(
                "<button onclick='btcl(this, currques, currques.op.indexOf(lc))'>" +
                  o[0] +
                  "</button> "
              );
            }
            // op.push("<button onclick='btcl(this, currques, currques.op.indexOf(lc))'>" + o[0] + "</button> ");
          });
          qhash += 1;
          if (qhash > 4 && qhash <= parseInt(f.value) && qc <= qhash)
            f.removeChild(f.children[0]);

          qh.innerText = "Q" + qhash;
          ops.innerHTML = op.join(" ");
        } else {
          dispques();
        }
      }

      function btcl(el, q) {
        self.ques.push([q.id, el.innerText]);
        // let j = Array.from(el.parentElement.children)
        // j.forEach(r=>{
        //     if(r.innerText == el.innerText)
        //     self.ques.push([q.id, j.indexOf(r)])
        // })
        if (qhash == qc) {
          p2.remove();
          p3.innerText = "completed\n generating your link...  ";
          fetch("/s", {
            headers: {
              "Content-Type": "application/json"
            },
            method: "post",
            body: JSON.stringify(self)
          }).then(e =>
            e.text().then(r => {
              p3.innerHTML =
                'your quiz link <a target="_blank" href="' +
                r +
                '">' +
                r +
                "</a>";
            })
          );
        }
        dispques();
      }

      form.onsubmit = e => {
        e.preventDefault();
        self.name = form.uname.value;
        p1.remove();
        setTimeout(() => {
          p2.removeAttribute("hidden");
        }, 200);
        dispques();
      };
      skip.onclick = () => {
        qhash -= 1;
        dispques();
      };
      f.oninput = () => {
        qc = parseInt(f.value);
      };
    </script>
  </body>
</html>
